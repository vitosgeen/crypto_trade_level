<!-- index.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Level Trader Bot</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f0f2f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        input,
        select {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        .delete-btn {
            background: #dc3545;
        }

        .delete-btn:hover {
            background: #a71d2a;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Level Trader Bot</h1>

        <div class="card">
            <h2>Add Level</h2>
            <form hx-post="/levels" hx-target="#levels-table">
                <input type="text" name="exchange" placeholder="Exchange (bybit)" value="bybit" required>
                <input type="text" name="symbol" placeholder="Symbol (BTCUSDT)" required>
                <input type="number" step="0.01" name="level_price" placeholder="Level Price" required>
                <input type="number" step="0.001" name="base_size" placeholder="Base Size" required>
                <input type="number" name="leverage" placeholder="Leverage" value="10" required>
                <select name="margin_type">
                    <option value="isolated">Isolated</option>
                    <option value="cross">Cross</option>
                </select>
                <input type="number" name="cool_down_ms" placeholder="Cooldown (ms)" value="5000" required>
                <div style="margin-top: 10px;">
                    <label>Tiers (%):</label>
                    <input type="number" step="0.0001" name="tier1" placeholder="Tier 1 (0.005)" value="0.005" required
                        style="width: 80px;">
                    <input type="number" step="0.0001" name="tier2" placeholder="Tier 2 (0.003)" value="0.003" required
                        style="width: 80px;">
                    <input type="number" step="0.0001" name="tier3" placeholder="Tier 3 (0.0015)" value="0.0015"
                        required style="width: 80px;">
                </div>
                <button type="submit" style="margin-top: 10px;">Add Level</button>
            </form>
        </div>

        <div class="card">
            <h2>Active Levels</h2>
            <div id="levels-table" hx-get="/levels" hx-trigger="every 2s">
                {{ template "levels_table" .Levels }}
            </div>
        </div>

        <div class="card">
            <h2>Active Positions</h2>
            <div id="positions-table" hx-get="/positions" hx-trigger="load, every 5s">
                <!-- Loaded via HTMX -->
            </div>
        </div>

        <div class="card">
            <h2>Recent Trades</h2>
            <div hx-get="/trades" hx-trigger="every 5s">
                <!-- Initial load or empty -->
            </div>
        </div>
    </div>
</body>

</html>

{{ define "levels_table" }}
<table>
    <thead>
        <tr>
            <th>Exchange</th>
            <th>Symbol</th>
            <th>Level Price</th>
            <th>Current Price</th>
            <th>Size</th>
            <th>Lev</th>
            <th>Cooldown</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {{ range . }}
        <tr>
            <td>{{ .Exchange }}</td>
            <td>{{ .Symbol }}</td>
            <td>{{ .LevelPrice }}</td>
            <td>{{ .CurrentPrice }}</td>
            <td>{{ .BaseSize }}</td>
            <td>{{ .Leverage }}</td>
            <td>{{ .CoolDownMs }}</td>
            <td>
                <button class="delete-btn" hx-delete="/levels/{{ .ID }}" hx-target="#levels-table">Delete</button>
            </td>
        </tr>
        {{ end }}
    </tbody>
</table>
{{ end }}

{{ define "trades_table" }}
<table>
    <thead>
        <tr>
            <th>Time</th>
            <th>Symbol</th>
            <th>Side</th>
            <th>Size</th>
            <th>Price</th>
        </tr>
    </thead>
    <tbody>
        {{ range . }}
        <tr>
            <td>{{ .CreatedAt.Format "15:04:05" }}</td>
            <td>{{ .Symbol }}</td>
            <td>{{ .Side }}</td>
            <td>{{ .Size }}</td>
            <td>{{ .Price }}</td>
        </tr>
        {{ end }}
    </tbody>
</table>
{{ end }}

{{ define "positions_table" }}
<table>
    <thead>
        <tr>
            <th>Symbol</th>
            <th>Side</th>
            <th>Size</th>
            <th>Entry Price</th>
            <th>Mark Price</th>
            <th>Unrealized PnL</th>
            <th>Lev</th>
        </tr>
    </thead>
    <tbody>
        {{ if . }}
        {{ range . }}
        <tr>
            <td>{{ .Symbol }}</td>
            <td>{{ .Side }}</td>
            <td>{{ .Size }}</td>
            <td>{{ .EntryPrice }}</td>
            <td>{{ .CurrentPrice }}</td>
            <td style="color: {{ if gt .UnrealizedPnL 0.0 }}green{{ else }}red{{ end }};">{{ .UnrealizedPnL }}</td>
            <td>{{ .Leverage }}</td>
        </tr>
        {{ end }}
        {{ else }}
        <tr>
            <td colspan="7">No active positions</td>
        </tr>
        {{ end }}
    </tbody>
</table>
{{ end }}