<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level Trader Bot - Dashboard</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0a0b1e;
            --text-color: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent-color: #00ff88;
            --accent-hover: #00cc6a;
            --secondary-color: #7000ff;
            --card-bg: #151632;
            --nav-bg: rgba(10, 11, 30, 0.95);
            --border-color: rgba(255, 255, 255, 0.05);
            --input-bg: #0f1025;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #007bff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding-top: 80px;
            /* Space for fixed nav */
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 1rem 2rem;
            background: var(--nav-bg);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
            text-decoration: none;
            letter-spacing: 1px;
        }

        .nav-links a {
            color: var(--text-color);
            text-decoration: none;
            margin-left: 2rem;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: var(--accent-color);
        }

        .cta-button {
            background: linear-gradient(45deg, var(--accent-color), var(--secondary-color));
            color: #000;
            padding: 0.5rem 1.2rem;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 700;
            transition: transform 0.3s, box-shadow 0.3s;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        /* Layout */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 1200px) {
            .container {
                grid-template-columns: 350px 1fr;
            }

            .full-width {
                grid-column: 1 / -1;
            }
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2,
        h3 {
            color: var(--text-color);
            margin-bottom: 15px;
        }

        h2 {
            font-size: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: var(--accent-color);
        }

        /* Forms */
        input,
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        button[type="submit"] {
            width: 100%;
            background: var(--info);
            color: white;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        button[type="submit"]:hover {
            background: #0056b3;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox-wrapper input {
            width: auto;
            margin: 0;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            text-align: left;
            padding: 12px;
            color: var(--text-muted);
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .delete-btn {
            background: rgba(220, 53, 69, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .delete-btn:hover {
            background: var(--danger);
            color: white;
        }

        /* Gauges */
        .gauges-grid {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .gauge {
            position: relative;
            width: 160px;
            height: 80px;
            overflow: hidden;
        }

        .gauge-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: conic-gradient(from 270deg, var(--danger) 0deg 90deg, var(--success) 90deg 180deg, transparent 180deg);
            clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%);
        }

        .gauge-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 4px;
            height: 70px;
            background: var(--text-color);
            transform-origin: bottom center;
            transform: rotate(-90deg);
            transition: transform 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
            z-index: 2;
            border-radius: 2px;
        }

        .gauge-center {
            position: absolute;
            bottom: -8px;
            left: 50%;
            width: 16px;
            height: 16px;
            background: var(--text-color);
            border-radius: 50%;
            transform: translateX(-50%);
            z-index: 3;
        }

        .gauge-labels {
            display: flex;
            justify-content: space-between;
            width: 160px;
            margin-top: 5px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .gauge-value {
            margin-top: 5px;
            font-family: 'Inter', monospace;
            font-size: 1rem;
            color: var(--text-color);
        }

        /* Chart */
        #levelChart {
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }


        /* Utilities */
        .text-success {
            color: var(--success);
        }

        .text-danger {
            color: var(--danger);
        }

        .text-muted {
            color: var(--text-muted);
        }

        .bg-success-subtle {
            background-color: rgba(40, 167, 69, 0.2);
        }

        .bg-danger-subtle {
            background-color: rgba(220, 53, 69, 0.2);
        }

        .flex-row {
            display: flex;
            gap: 10px;
        }

        .flex-1 {
            flex: 1;
        }
    </style>
</head>

<body>

    <nav>
        <a href="/" class="logo">CRYPTOBOT</a>
        <div class="nav-links">
            <a href="/#features">Features</a>
            <a href="/speed-bot">Speed Bot</a>
            <a href="/dashboard" style="color: var(--accent-color);">Dashboard</a>
        </div>
        <a href="/dashboard" class="cta-button">Launch App</a>
    </nav>

    <div class="container">
        <!-- Left Column: Controls -->
        <div class="card">
            <h2>Add Level</h2>
            <form id="add-level-form" hx-post="/levels" hx-target="#levels-table">
                <div class="flex-row">
                    <input type="text" name="exchange" placeholder="Exchange" value="bybit" required class="flex-1">
                    <input type="text" name="symbol" placeholder="Symbol (BTCUSDT)" required class="flex-1">
                </div>

                <input type="number" step="0.000001" name="level_price" id="input-level-price" placeholder="Level Price"
                    required>

                <div class="flex-row">
                    <input type="number" step="0.001" name="base_size" placeholder="Base Size" required class="flex-1">
                    <input type="number" name="leverage" placeholder="Lev" value="10" required style="width: 80px;">
                </div>

                <select name="margin_type">
                    <option value="isolated">Isolated</option>
                    <option value="cross">Cross</option>
                </select>

                <div class="flex-row">
                    <input type="number" name="cool_down_ms" placeholder="Cooldown (ms)" value="5000" required
                        class="flex-1">
                    <input type="number" step="0.1" name="take_profit_pct" placeholder="TP %" value="2.0" required
                        class="flex-1">
                </div>

                <label>Tiers (%):</label>
                <div class="flex-row" style="align-items: flex-start;">
                    <div class="flex-1">
                        <input type="number" step="0.01" name="tier1" id="input-tier1" placeholder="T1 (0.5)"
                            value="0.5" required>
                        <div id="tip-tier1" style="font-size: 0.75em; margin-top: -8px; margin-bottom: 8px;"></div>
                    </div>
                    <div class="flex-1">
                        <input type="number" step="0.01" name="tier2" id="input-tier2" placeholder="T2 (0.3)"
                            value="0.3" required>
                        <div id="tip-tier2" style="font-size: 0.75em; margin-top: -8px; margin-bottom: 8px;"></div>
                    </div>
                    <div class="flex-1">
                        <input type="number" step="0.01" name="tier3" id="input-tier3" placeholder="T3 (0.15)"
                            value="0.15" required>
                        <div id="tip-tier3" style="font-size: 0.75em; margin-top: -8px; margin-bottom: 8px;"></div>
                    </div>
                </div>

                <div class="checkbox-wrapper">
                    <input type="checkbox" name="stop_loss_at_base" id="sl-base">
                    <label for="sl-base" style="margin:0; cursor:pointer;">Stop Loss at Base</label>
                </div>

                <label>Stop Loss Mode</label>
                <select name="stop_loss_mode">
                    <option value="exchange">Exchange (Order)</option>
                    <option value="app">App (Programmatic)</option>
                </select>

                <div class="checkbox-wrapper">
                    <input type="checkbox" name="disable_speed_close" id="disable-speed">
                    <label for="disable-speed" style="margin:0; cursor:pointer;">Disable Speed-Based Close</label>
                </div>

                <button type="submit" style="margin-top: 10px;">Add Level</button>
            </form>
        </div>

        <!-- Right Column: Market Stats & Chart -->
        <div style="display: flex; flex-direction: column; gap: 20px;">

            <!-- Market Stats -->
            <div class="card">
                <h2>Market Speed & Depth</h2>
                <div class="gauges-grid">
                    <!-- Gauge 1: Trade Speed -->
                    <div class="gauge-container">
                        <h3 style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px;">Trade Volume (60s)
                        </h3>
                        <div class="gauge">
                            <div class="gauge-bg"></div>
                            <div class="gauge-needle" id="speed-needle"></div>
                            <div class="gauge-center"></div>
                        </div>
                        <div class="gauge-labels">
                            <span class="text-danger">Sell</span>
                            <span class="text-success">Buy</span>
                        </div>
                        <div class="gauge-value" id="speed-value">0 / 0</div>
                    </div>

                    <!-- Gauge 2: Order Book Depth -->
                    <div class="gauge-container">
                        <h3 style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px;">Order Book Depth
                        </h3>
                        <div class="gauge">
                            <div class="gauge-bg"></div>
                            <div class="gauge-needle" id="depth-needle"></div>
                            <div class="gauge-center"></div>
                        </div>
                        <div class="gauge-labels">
                            <span class="text-danger">Ask</span>
                            <span class="text-success">Bid</span>
                        </div>
                        <div class="gauge-value" id="depth-value">0 / 0</div>
                    </div>

                    <!-- Gauge 3: Divergence -->
                    <div class="gauge-container">
                        <h3 style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px;">Sentiment
                            Divergence</h3>
                        <div class="gauge">
                            <div class="gauge-bg"
                                style="background: conic-gradient(from 270deg, var(--warning) 0deg 90deg, var(--info) 90deg 180deg, transparent 180deg);">
                            </div>
                            <div class="gauge-needle" id="div-needle"></div>
                            <div class="gauge-center"></div>
                        </div>
                        <div class="gauge-labels">
                            <span style="color: var(--warning);">Bearish</span>
                            <span style="color: var(--info);">Bullish</span>
                        </div>
                        <div class="gauge-value" id="div-value">0.00</div>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="card" id="chart-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0; border: none;">Price Chart</h2>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label for="level-selector" style="margin: 0;">Level:</label>
                        <select id="level-selector" onchange="changeLevel()"
                            style="width: auto; margin: 0; padding: 5px;">
                            <option value="" selected disabled>Select a level...</option>
                            {{range .Levels}}
                            <option value="{{.Symbol}}-{{.LevelPrice}}">{{.Exchange}} - {{.Symbol}} - {{.LevelPrice}}
                            </option>
                            {{end}}
                        </select>
                    </div>
                </div>
                <div id="levelChart" style="width: 100%; height: 400px;"></div>
                <div style="margin-top: 10px; font-size: 0.85rem; color: var(--text-muted); text-align: center;">
                    <span style="color: #000; background: #fff; padding: 0 4px; border-radius: 2px;">‚îÅ</span> Base Level
                    |
                    <span style="color: var(--text-muted); border-bottom: 1px dashed var(--text-muted);">---</span>
                    Tiers
                    |
                    Cursor: <span id="cursor-percent"
                        style="font-family: 'Inter', monospace; font-weight: 600;">0.00%</span>
                </div>
            </div>

        </div>

        <!-- Full Width: Active Levels -->
        <div class="card full-width">
            <h2>Active Levels</h2>
            <div id="levels-table" hx-get="/levels" hx-trigger="every 2s">
                {{ template "levels_table" .Levels }}
            </div>
        </div>

        <!-- Full Width: Active Positions -->
        <div class="card full-width">
            <h2>Active Positions</h2>
            <div id="positions-table" hx-get="/positions" hx-trigger="load, every 5s">
                <!-- Loaded via HTMX -->
            </div>
        </div>

        <!-- Full Width: Positions History -->
        <div class="card full-width">
            <h2>Positions History</h2>
            <div id="history-table" hx-get="/history" hx-trigger="load, every 10s">
                {{ template "history_table" .History }}
            </div>
        </div>

        <!-- Full Width: Recent Trades -->
        <div class="card full-width">
            <h2>Recent Trades</h2>
            <div hx-get="/trades" hx-trigger="every 5s">
                <!-- Initial load or empty -->
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let candleSeries = null;
        let liquiditySeries = null;
        let selectedLevelId = null;
        let currentPriceLines = [];
        let previewPriceLines = [];
        let isShiftPressed = false;
        let lastCrosshairPrice = null;
        let borderResetTimeout = null;
        let chartHovered = false;

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Shift' && chartHovered) {
                isShiftPressed = true;
                if (lastCrosshairPrice) {
                    updatePreview(lastCrosshairPrice);
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'Shift') {
                isShiftPressed = false;
                clearPreview();
            }
        });

        function initChart() {
            const chartContainer = document.getElementById('levelChart');
            if (!chartContainer) return;

            chartContainer.innerHTML = '';

            if (typeof LightweightCharts === 'undefined') return;

            try {
                chart = LightweightCharts.createChart(chartContainer, {
                    width: chartContainer.clientWidth,
                    height: 400,
                    layout: {
                        background: { type: 'solid', color: '#151632' },
                        textColor: '#e0e0e0',
                    },
                    grid: {
                        vertLines: { color: 'rgba(255, 255, 255, 0.05)' },
                        horzLines: { color: 'rgba(255, 255, 255, 0.05)' },
                    },
                    rightPriceScale: {
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                    },
                    timeScale: {
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        timeVisible: true,
                        secondsVisible: false,
                    },
                });

                liquiditySeries = chart.addLineSeries({
                    color: 'transparent',
                    lineWidth: 0,
                    crosshairMarkerVisible: false,
                    lastValueVisible: false,
                    priceLineVisible: false,
                    priceFormat: {
                        type: 'price',
                        precision: 6,
                        minMove: 0.000001,
                    },
                });

                candleSeries = chart.addCandlestickSeries({
                    upColor: '#00ff88',
                    downColor: '#dc3545',
                    borderVisible: false,
                    wickUpColor: '#00ff88',
                    wickDownColor: '#dc3545',
                    priceFormat: {
                        type: 'price',
                        precision: 6,
                        minMove: 0.000001,
                    },
                });
                chart.timeScale().fitContent();

                const chartElement = chart.chartElement();
                chartElement.addEventListener('mouseenter', () => chartHovered = true);
                chartElement.addEventListener('mouseleave', () => {
                    chartHovered = false;
                    isShiftPressed = false;
                    clearPreview();
                });

                window.addEventListener('resize', () => {
                    if (chart && chartContainer) {
                        chart.applyOptions({ width: chartContainer.clientWidth });
                    }
                });

                chart.subscribeClick((param) => {
                    if (!isShiftPressed || !param.point) return;

                    const price = candleSeries.coordinateToPrice(param.point.y);
                    if (price) {
                        const priceInput = document.getElementById('input-level-price');
                        if (priceInput) {
                            priceInput.value = price.toFixed(6); // Match step precision

                            // Visual feedback
                            const originalColor = priceInput.style.borderColor;
                            priceInput.style.borderColor = '#00ff88';

                            if (borderResetTimeout) clearTimeout(borderResetTimeout);
                            borderResetTimeout = setTimeout(() => {
                                priceInput.style.borderColor = originalColor;
                            }, 500);

                            // Submit form
                            htmx.trigger('#add-level-form', 'submit');
                        }
                    }
                });

                chart.subscribeCrosshairMove((param) => {
                    const percentSpan = document.getElementById('cursor-percent');

                    if (!param.point) {
                        lastCrosshairPrice = null;
                        clearPreview();
                        if (percentSpan) {
                            percentSpan.textContent = '0.00%';
                            percentSpan.style.color = 'var(--text-muted)';
                        }
                        return;
                    }

                    const price = candleSeries.coordinateToPrice(param.point.y);
                    lastCrosshairPrice = price;

                    // Percentage logic
                    if (percentSpan && price) {
                        const data = candleSeries.data();
                        if (data.length > 0) {
                            const lastCandle = data[data.length - 1];
                            const currentPrice = lastCandle.close;
                            const diff = price - currentPrice;
                            const diffPct = (diff / currentPrice) * 100;

                            percentSpan.textContent = `${diffPct > 0 ? '+' : ''}${diffPct.toFixed(2)}%`;
                            percentSpan.style.color = diffPct >= 0 ? 'var(--success)' : 'var(--danger)';
                        }
                    }

                    if (isShiftPressed) {
                        updatePreview(price);
                    } else {
                        clearPreview();
                    }
                });
            } catch (e) {
                console.error("Error initializing chart:", e);
            }
        }

        function clearPreview() {
            if (!candleSeries || previewPriceLines.length === 0) return;
            previewPriceLines.forEach(line => candleSeries.removePriceLine(line));
            previewPriceLines = [];
        }

        function updatePreview(basePrice) {
            if (!candleSeries) return;
            clearPreview();
            if (!basePrice) return;

            // Get Tier Percentages from form
            const t1Input = document.getElementById('input-tier1');
            const t2Input = document.getElementById('input-tier2');
            const t3Input = document.getElementById('input-tier3');

            const t1Pct = t1Input && !isNaN(parseFloat(t1Input.value)) ? parseFloat(t1Input.value) / 100 : 0.005;
            const t2Pct = t2Input && !isNaN(parseFloat(t2Input.value)) ? parseFloat(t2Input.value) / 100 : 0.003;
            const t3Pct = t3Input && !isNaN(parseFloat(t3Input.value)) ? parseFloat(t3Input.value) / 100 : 0.0015;

            const longTier1 = basePrice * (1 + t1Pct);
            const longTier2 = basePrice * (1 + t2Pct);
            const longTier3 = basePrice * (1 + t3Pct);
            const shortTier1 = basePrice * (1 - t1Pct);
            const shortTier2 = basePrice * (1 - t2Pct);
            const shortTier3 = basePrice * (1 - t3Pct);

            const addPreviewLine = (price, label, color) => {
                previewPriceLines.push(candleSeries.createPriceLine({
                    price: price,
                    color: color,
                    lineWidth: 1,
                    lineStyle: LightweightCharts.LineStyle.Dashed,
                    axisLabelVisible: false,
                    title: label,
                }));
            };

            // Base
            previewPriceLines.push(candleSeries.createPriceLine({
                price: basePrice,
                color: 'rgba(255, 255, 255, 0.5)',
                lineWidth: 1,
                lineStyle: LightweightCharts.LineStyle.Solid,
                axisLabelVisible: true,
                title: 'Preview',
            }));

            // Tiers (Translucent)
            addPreviewLine(longTier1, 'L-T1', 'rgba(0, 255, 136, 0.5)');
            addPreviewLine(longTier2, 'L-T2', 'rgba(0, 255, 136, 0.5)');
            addPreviewLine(longTier3, 'L-T3', 'rgba(0, 255, 136, 0.5)');

            addPreviewLine(shortTier1, 'S-T1', 'rgba(220, 53, 69, 0.5)');
            addPreviewLine(shortTier2, 'S-T2', 'rgba(220, 53, 69, 0.5)');
            addPreviewLine(shortTier3, 'S-T3', 'rgba(220, 53, 69, 0.5)');
        }

        function changeLevel() {
            const selector = document.getElementById('level-selector');
            selectedLevelId = selector.value;
            updateChart();
        }

        async function updateChart() {
            if (!chart) {
                initChart();
                if (!chart) return;
            }

            if (!candleSeries || !liquiditySeries) {
                initChart();
                if (!candleSeries) return;
            }

            const table = document.querySelector('#levels-table table');
            if (!table) return;

            const rows = table.querySelectorAll('tbody tr');

            // Selector logic
            const selector = document.getElementById('level-selector');
            if (!selector) return;

            const currentOptions = Array.from(selector.options).map(o => o.value);
            const activeIds = [];
            const availableLevels = [];

            rows.forEach((row) => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 3) return;
                const symbol = cells[1].textContent.trim();
                const levelPrice = parseFloat(cells[2].textContent);
                const id = `${symbol}-${levelPrice}`;
                activeIds.push(id);
                availableLevels.push({ id, text: `${symbol} @ ${levelPrice}` });

                if (!currentOptions.includes(id)) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.text = `${symbol} @ ${levelPrice}`;
                    selector.appendChild(option);
                }
            });

            Array.from(selector.options).forEach(option => {
                if (option.value && !activeIds.includes(option.value)) {
                    selector.removeChild(option);
                }
            });

            if ((!selectedLevelId || !activeIds.includes(selectedLevelId)) && availableLevels.length > 0) {
                selectedLevelId = availableLevels[0].id;
                selector.value = selectedLevelId;
            }

            let targetRow = null;
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 3) return;
                const symbol = cells[1].textContent.trim();
                const levelPrice = parseFloat(cells[2].textContent);
                const id = `${symbol}-${levelPrice}`;
                if (id === selectedLevelId) {
                    targetRow = row;
                }
            });

            if (!targetRow) return;

            const cells = targetRow.querySelectorAll('td');
            const symbol = cells[1].textContent.trim();
            const levelPrice = parseFloat(cells[2].textContent);

            try {
                const response = await fetch(`/api/candles?symbol=${symbol}&interval=1&limit=200`);
                const candles = await response.json();
                if (candles && candles.length > 0) {
                    candles.sort((a, b) => a.time - b.time);
                    const uniqueCandles = [];
                    const seenTimes = new Set();
                    for (const c of candles) {
                        if (!seenTimes.has(c.time)) {
                            seenTimes.add(c.time);
                            uniqueCandles.push(c);
                        }
                    }
                    candleSeries.setData(uniqueCandles);
                    const lineData = uniqueCandles.map(c => ({ time: c.time, value: c.close }));
                    liquiditySeries.setData(lineData);

                    if (window.lastChartSymbol !== symbol) {
                        chart.timeScale().fitContent();
                        chart.priceScale('right').applyOptions({ autoScale: true });
                        window.lastChartSymbol = symbol;
                    }
                }
            } catch (e) {
                console.error("Failed to fetch candles", e);
            }

            // Tiers
            const tierCell = cells[4];
            let longTier1, longTier2, longTier3, shortTier1, shortTier2, shortTier3;

            // Parse from the div/span structure
            // Structure:
            // div (grid)
            //   span (LONG)
            //   div (flex) -> span (T1), span (T2), span (T3)
            //   span (SHORT)
            //   div (flex) -> span (T1), span (T2), span (T3)

            const tierDivs = tierCell.querySelectorAll('div > div'); // The two flex divs
            if (tierDivs.length >= 2) {
                const longSpans = tierDivs[0].querySelectorAll('span');
                if (longSpans.length >= 3) {
                    longTier1 = parseFloat(longSpans[0].textContent);
                    longTier2 = parseFloat(longSpans[1].textContent);
                    longTier3 = parseFloat(longSpans[2].textContent);
                }

                const shortSpans = tierDivs[1].querySelectorAll('span');
                if (shortSpans.length >= 3) {
                    shortTier1 = parseFloat(shortSpans[0].textContent);
                    shortTier2 = parseFloat(shortSpans[1].textContent);
                    shortTier3 = parseFloat(shortSpans[2].textContent);
                }
            }

            if (!longTier1) {
                longTier1 = levelPrice * (1 + 0.005);
                longTier2 = levelPrice * (1 + 0.003);
                longTier3 = levelPrice * (1 + 0.0015);
                shortTier1 = levelPrice * (1 - 0.005);
                shortTier2 = levelPrice * (1 - 0.003);
                shortTier3 = levelPrice * (1 - 0.0015);
            }

            const levelDetails = {
                price: levelPrice,
                long: [longTier1, longTier2, longTier3],
                short: [shortTier1, shortTier2, shortTier3]
            };
            const levelDetailsJson = JSON.stringify(levelDetails);

            if (window.lastLevelDetails !== levelDetailsJson) {
                if (window.currentLevelLines) {
                    window.currentLevelLines.forEach(line => candleSeries.removePriceLine(line));
                }
                window.currentLevelLines = [];

                window.currentLevelLines.push(candleSeries.createPriceLine({
                    price: levelPrice,
                    color: '#ffffff',
                    lineWidth: 2,
                    lineStyle: LightweightCharts.LineStyle.Solid,
                    axisLabelVisible: true,
                    title: 'Base',
                }));

                const addTierLine = (price, label, color) => {
                    window.currentLevelLines.push(candleSeries.createPriceLine({
                        price: price,
                        color: color,
                        lineWidth: 1,
                        lineStyle: LightweightCharts.LineStyle.Dashed,
                        axisLabelVisible: true,
                        title: label,
                    }));
                };

                addTierLine(longTier1, 'L-T1', '#00ff88');
                addTierLine(longTier2, 'L-T2', '#00ff88');
                addTierLine(longTier3, 'L-T3', '#00ff88');

                addTierLine(shortTier1, 'S-T1', '#dc3545');
                addTierLine(shortTier2, 'S-T2', '#dc3545');
                addTierLine(shortTier3, 'S-T3', '#dc3545');

                window.lastLevelDetails = levelDetailsJson;
            }

            // Liquidity
            try {
                const liqResp = await fetch(`/api/liquidity?symbol=${symbol}`);
                const clusters = await liqResp.json();
                const clustersJson = JSON.stringify(clusters);

                if (window.lastLiquidityJson !== clustersJson) {
                    if (window.currentLiquidityLines) {
                        window.currentLiquidityLines.forEach(line => liquiditySeries.removePriceLine(line));
                    }
                    window.currentLiquidityLines = [];

                    if (clusters && clusters.length > 0) {
                        const maxVol = Math.max(...clusters.map(c => c.volume));
                        clusters.forEach(c => {
                            let opacity = 0.0;
                            if (maxVol > 0) {
                                opacity = c.volume / maxVol;
                                if (opacity > 1.0) opacity = 1.0;
                                if (opacity < 0.0) opacity = 0.0;
                            }
                            if (opacity < 0.1) opacity = 0.1;

                            const color = c.type === 'bid'
                                ? `rgba(0, 255, 136, ${opacity.toFixed(2)})`
                                : `rgba(220, 53, 69, ${opacity.toFixed(2)})`;

                            window.currentLiquidityLines.push(liquiditySeries.createPriceLine({
                                price: c.price,
                                color: color,
                                lineWidth: 2,
                                lineStyle: LightweightCharts.LineStyle.Solid,
                                axisLabelVisible: false,
                                title: '',
                            }));
                        });
                    }
                    window.lastLiquidityJson = clustersJson;
                }
            } catch (e) {
                console.error("Failed to fetch liquidity", e);
            }
        }

        document.body.addEventListener('htmx:afterSwap', function (event) {
            if (event.detail.target.id === 'levels-table') {
                updateChart();
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(updateChart, 500);
            setTimeout(updateTierTips, 100);
        });

        function updateTierTips() {
            const priceInput = document.getElementById('input-level-price');
            if (!priceInput) return;

            const price = parseFloat(priceInput.value);
            if (isNaN(price)) return;

            ['tier1', 'tier2', 'tier3'].forEach(tier => {
                const input = document.getElementById(`input-${tier}`);
                const tip = document.getElementById(`tip-${tier}`);
                if (!input || !tip) return;

                const pct = parseFloat(input.value);
                if (isNaN(pct)) {
                    tip.innerHTML = '';
                    return;
                }

                const longPrice = price * (1 + pct / 100);
                const shortPrice = price * (1 - pct / 100);

                tip.innerHTML = `<span class="text-success" title="Long">L:${longPrice.toFixed(6)}</span> | <span class="text-danger" title="Short">S:${shortPrice.toFixed(6)}</span>`;
            });
        }

        const priceInput = document.getElementById('input-level-price');
        if (priceInput) priceInput.addEventListener('input', updateTierTips);
        ['tier1', 'tier2', 'tier3'].forEach(tier => {
            const input = document.getElementById(`input-${tier}`);
            if (input) input.addEventListener('input', updateTierTips);
        });

        async function updateMarketStats() {
            const selector = document.getElementById('level-selector');
            let symbol = "BTCUSDT";
            if (selector && selector.value) {
                const lastHyphen = selector.value.lastIndexOf('-');
                if (lastHyphen > 0) symbol = selector.value.substring(0, lastHyphen);
            }

            try {
                const resp = await fetch(`/api/market-stats?symbol=${symbol}`);
                const stats = await resp.json();

                const totalSpeed = stats.speed_buy + stats.speed_sell;
                let speedRatio = 0.5;
                if (totalSpeed > 0) speedRatio = stats.speed_buy / totalSpeed;
                const speedDeg = (speedRatio * 180) - 90;
                const speedNeedle = document.getElementById('speed-needle');
                if (speedNeedle) speedNeedle.style.transform = `rotate(${speedDeg}deg)`;
                const speedValue = document.getElementById('speed-value');
                if (speedValue) speedValue.textContent = `${stats.speed_sell.toFixed(2)} / ${stats.speed_buy.toFixed(2)}`;

                const totalDepth = stats.depth_bid + stats.depth_ask;
                let depthRatio = 0.5;
                if (totalDepth > 0) depthRatio = stats.depth_bid / totalDepth;
                const depthDeg = (depthRatio * 180) - 90;
                const depthNeedle = document.getElementById('depth-needle');
                if (depthNeedle) depthNeedle.style.transform = `rotate(${depthDeg}deg)`;
                const depthValue = document.getElementById('depth-value');
                if (depthValue) depthValue.textContent = `${stats.depth_ask.toFixed(2)} / ${stats.depth_bid.toFixed(2)}`;

                const divergence = speedRatio - depthRatio;
                const divDeg = divergence * 90;
                const divNeedle = document.getElementById('div-needle');
                if (divNeedle) divNeedle.style.transform = `rotate(${divDeg}deg)`;
                const divValue = document.getElementById('div-value');
                if (divValue) divValue.textContent = divergence.toFixed(2);

            } catch (e) {
                console.error("Failed to fetch market stats", e);
            }
        }

        setInterval(updateMarketStats, 1000);
        const levelSelector = document.getElementById('level-selector');
        if (levelSelector) levelSelector.addEventListener('change', updateMarketStats);

        function selectLevel(levelId) {
            const selector = document.getElementById('level-selector');
            if (selector) {
                // Check if option exists, if not, it might be added by updateChart logic later, 
                // but usually it should be there if it's in the table.
                // However, the selector options are populated by updateChart based on the table rows.
                // So we can just set the value.
                selector.value = levelId;
                // Trigger change event manually
                const event = new Event('change');
                selector.dispatchEvent(event);

                // Scroll chart into view
                const chartCard = document.getElementById('chart-card');
                if (chartCard) {
                    chartCard.scrollIntoView({ behavior: 'smooth' });
                }
            }
        }
    </script>
</body>

</html>

{{ define "levels_table" }}
<table>
    <thead>
        <tr>
            <th>Exchange</th>
            <th>Symbol</th>
            <th>Level Price</th>
            <th>Current Price</th>
            <th>Zone/Tiers</th>
            <th>Size</th>
            <th>Lev</th>
            <th>Margin</th>
            <th>Cooldown</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {{ range . }}
        <tr>
            <td>{{ .Exchange }}</td>
            <td onclick="selectLevel('{{.Symbol}}-{{.LevelPrice}}')" style="cursor: pointer; transition: color 0.2s;"
                title="Click to view on chart">
                <strong style="color: var(--accent-color);">{{ .Symbol }}</strong>
            </td>
            <td>{{ printf "%.6f" .LevelPrice }}</td>
            <td>{{ printf "%.6f" .CurrentPrice }}</td>
            <td>
                <div style="font-size: 0.85em; display: grid; grid-template-columns: auto 1fr; gap: 5px;">
                    <span class="text-success" style="font-weight: bold;">LONG</span>
                    <div style="display: flex; gap: 5px;">
                        <span class="bg-success-subtle" style="padding: 0 4px; border-radius: 2px;">{{ printf "%.6f"
                            (index .LongTiers 0) }}</span>
                        <span class="bg-success-subtle" style="padding: 0 4px; border-radius: 2px;">{{ printf "%.6f"
                            (index .LongTiers 1) }}</span>
                        <span class="bg-success-subtle" style="padding: 0 4px; border-radius: 2px;">{{ printf "%.6f"
                            (index .LongTiers 2) }}</span>
                    </div>
                    <span class="text-danger" style="font-weight: bold;">SHORT</span>
                    <div style="display: flex; gap: 5px;">
                        <span class="bg-danger-subtle" style="padding: 0 4px; border-radius: 2px;">{{ printf "%.6f"
                            (index .ShortTiers 0) }}</span>
                        <span class="bg-danger-subtle" style="padding: 0 4px; border-radius: 2px;">{{ printf "%.6f"
                            (index .ShortTiers 1) }}</span>
                        <span class="bg-danger-subtle" style="padding: 0 4px; border-radius: 2px;">{{ printf "%.6f"
                            (index .ShortTiers 2) }}</span>
                    </div>
                </div>
            </td>
            <td>{{ .BaseSize }}</td>
            <td>{{ .Leverage }}x</td>
            <td style="color: {{ if eq .MarginType " isolated" }}var(--info){{ else }}var(--text-muted){{ end }};
                font-weight: bold;">
                {{ .MarginType }}</td>
            <td>{{ .CoolDownMs }}ms</td>
            <td>{{ if .StopLossAtBase }}<span class="text-danger" style="font-weight: bold;">YES</span>{{ else }}NO{{
                end }}
            </td>
            <td>
                <button class="delete-btn" hx-delete="/levels/{{ .ID }}" hx-target="#levels-table">Delete</button>
            </td>
        </tr>
        {{ end }}
    </tbody>
</table>
{{ end }}

{{ define "trades_table" }}
<table>
    <thead>
        <tr>
            <th>Time</th>
            <th>Symbol</th>
            <th>Side</th>
            <th>Size</th>
            <th>Price</th>
            <th>Profit</th>
        </tr>
    </thead>
    <tbody>
        {{ range . }}
        <tr>
            <td class="text-muted">{{ .CreatedAt.Format "15:04:05" }}</td>
            <td>{{ .Symbol }}</td>
            <td style="color: {{ if eq .Side " Buy" }}var(--success){{ else }}var(--danger){{ end }};">{{ .Side }}</td>
            <td>{{ if eq .Size 0.0 }}-{{ else }}{{ .Size }}{{ end }}</td>
            <td>{{ printf "%.2f" .Price }}</td>
            <td
                style="color: {{ if gt .RealizedPnL 0.0 }}var(--success){{ else if lt .RealizedPnL 0.0 }}var(--danger){{ else }}var(--text-muted){{ end }}; font-weight: bold;">
                {{ if ne .RealizedPnL 0.0 }}{{ printf "%.4f" .RealizedPnL }}{{ else }}-{{ end }}
            </td>
        </tr>
        {{ end }}
    </tbody>
</table>
{{ end }}

{{ define "positions_table" }}
<table>
    <thead>
        <tr>
            <th>Symbol</th>
            <th>Side</th>
            <th>Size</th>
            <th>Entry Price</th>
            <th>Mark Price</th>
            <th>Unrealized PnL</th>
            <th>Lev</th>
            <th>Margin</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {{ if . }}
        {{ range . }}
        <tr>
            <td><strong style="color: var(--accent-color);">{{ .Symbol }}</strong></td>
            <td style="color: {{ if eq .Side " Buy" }}var(--success){{ else }}var(--danger){{ end }}; font-weight:
                bold;">{{ .Side }}</td>
            <td>{{ .Size }}</td>
            <td>{{ printf "%.6f" .EntryPrice }}</td>
            <td>{{ printf "%.6f" .CurrentPrice }}</td>
            <td
                style="color: {{ if gt .UnrealizedPnL 0.0 }}var(--success){{ else }}var(--danger){{ end }}; font-weight: bold;">
                {{ printf "%.6f" .UnrealizedPnL }}</td>
            <td>{{ .Leverage }}</td>
            <td style="color: {{ if eq .MarginType " isolated" }}var(--info){{ else }}var(--text-muted){{ end }};
                font-weight: bold;">
                {{ .MarginType }}</td>
            <td>
                <button class="delete-btn" hx-delete="/positions/{{ .Symbol }}" hx-target="#positions-table"
                    hx-confirm="Are you sure you want to close this position?">Close</button>
            </td>
        </tr>
        {{ end }}
        {{ else }}
        <tr>
            <td colspan="9" style="text-align: center; color: var(--text-muted); padding: 20px;">No active positions
            </td>
        </tr>
        {{ end }}
    </tbody>
</table>
{{ end }}

{{ define "history_table" }}
<table>
    <thead>
        <tr>
            <th>Time</th>
            <th>Symbol</th>
            <th>Side</th>
            <th>Size</th>
            <th>Entry</th>
            <th>Exit</th>
            <th>PnL</th>
            <th>Lev</th>
            <th>Margin</th>
        </tr>
    </thead>
    <tbody>
        {{ if . }}
        {{ range . }}
        <tr>
            <td class="text-muted">{{ .ClosedAt.Format "15:04:05" }}</td>
            <td><strong>{{ .Symbol }}</strong></td>
            <td style="color: {{ if eq .Side " Buy" }}var(--success){{ else }}var(--danger){{ end }}; font-weight:
                bold;">{{ .Side }}</td>
            <td>{{ .Size }}</td>
            <td>{{ printf "%.6f" .EntryPrice }}</td>
            <td>{{ printf "%.6f" .ExitPrice }}</td>
            <td
                style="color: {{ if gt .RealizedPnL 0.0 }}var(--success){{ else if lt .RealizedPnL 0.0 }}var(--danger){{ else }}var(--text-muted){{ end }}; font-weight: bold;">
                {{ printf "%.4f" .RealizedPnL }}
            </td>
            <td>{{ .Leverage }}x</td>
            <td>{{ .MarginType }}</td>
        </tr>
        {{ end }}
        {{ else }}
        <tr>
            <td colspan="9" style="text-align: center; color: var(--text-muted); padding: 20px;">No history available
            </td>
        </tr>
        {{ end }}
    </tbody>
</table>
{{ end }}
```