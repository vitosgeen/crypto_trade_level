<!-- index.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Level Trader Bot</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f0f2f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        input,
        select {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        .delete-btn {
            background: #dc3545;
        }

        .delete-btn:hover {
            background: #a71d2a;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Level Trader Bot</h1>

        <div class="card">
            <h2>Add Level</h2>
            <form hx-post="/levels" hx-target="#levels-table">
                <input type="text" name="exchange" placeholder="Exchange (bybit)" value="bybit" required>
                <input type="text" name="symbol" placeholder="Symbol (BTCUSDT)" required>
                <input type="number" step="0.01" name="level_price" placeholder="Level Price" required>
                <input type="number" step="0.001" name="base_size" placeholder="Base Size" required>
                <input type="number" name="leverage" placeholder="Leverage" value="10" required>
                <select name="margin_type">
                    <option value="isolated">Isolated</option>
                    <option value="cross">Cross</option>
                </select>
                <input type="number" name="cool_down_ms" placeholder="Cooldown (ms)" value="5000" required>
                <div style="margin-top: 10px;">
                    <label>Tiers (%):</label>
                    <input type="number" step="0.01" name="tier1" placeholder="Tier 1 (0.5)" value="0.5" required
                        style="width: 80px;">
                    <input type="number" step="0.01" name="tier2" placeholder="Tier 2 (0.3)" value="0.3" required
                        style="width: 80px;">
                    <input type="number" step="0.01" name="tier3" placeholder="Tier 3 (0.15)" value="0.15" required
                        style="width: 80px;">
                </div>
                <button type="submit" style="margin-top: 10px;">Add Level</button>
            </form>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">Level Visualization</h2>
                <div style="display: flex; align-items: center;">
                    <label for="level-selector" style="margin-right: 10px; font-weight: bold;">Select Level:</label>
                    <select id="level-selector" onchange="changeLevel()"
                        style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="">Loading levels...</option>
                    </select>
                </div>
            </div>
            <div style="position: relative; height: 400px;">
                <canvas id="levelChart"></canvas>
            </div>
            <div id="chart-legend" style="margin-top: 10px; font-size: 12px; color: #666;">
                <span style="color: #28a745;">█</span> LONG Zone (above level) |
                <span style="color: #dc3545;">█</span> SHORT Zone (below level) |
                <span style="color: #000;">━</span> Base Level |
                <span style="color: #666;">- - -</span> Tiers
            </div>
        </div>

        <div class="card">
            <h2>Active Levels</h2>
            <div id="levels-table" hx-get="/levels" hx-trigger="every 2s">
                {{ template "levels_table" .Levels }}
            </div>
        </div>

        <script>
            let levelChart = null;
            let selectedLevelId = null; // Store selected level ID (symbol + price)
            let priceHistory = {}; // Store history per level: { "BTCUSDT-85000": [price1, price2...] }
            const MAX_HISTORY = 100; // Keep last 100 points

            function changeLevel() {
                const selector = document.getElementById('level-selector');
                selectedLevelId = selector.value;
                updateChart();
            }

            function updateChart() {
                // Get data from the levels table
                const table = document.querySelector('#levels-table table');
                if (!table) return;

                const rows = table.querySelectorAll('tbody tr');
                if (rows.length === 0) return;

                // Populate selector if empty or options changed
                const selector = document.getElementById('level-selector');
                const currentOptions = Array.from(selector.options).map(o => o.value);
                const availableLevels = [];
                const activeIds = []; // Track currently active IDs

                rows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    const symbol = cells[1].textContent.trim();
                    const levelPrice = parseFloat(cells[2].textContent);
                    const id = `${symbol}-${levelPrice}`;
                    activeIds.push(id);
                    availableLevels.push({ id, text: `${symbol} @ ${levelPrice}` });

                    // Add option if not exists
                    if (!currentOptions.includes(id)) {
                        const option = document.createElement('option');
                        option.value = id;
                        option.text = `${symbol} @ ${levelPrice}`;
                        selector.appendChild(option);
                    }
                });

                // Remove options that are no longer active (except the loading placeholder if needed)
                Array.from(selector.options).forEach(option => {
                    if (option.value && !activeIds.includes(option.value)) {
                        selector.removeChild(option);
                    }
                });

                // Select first level by default if nothing selected or selection is invalid
                if ((!selectedLevelId || !activeIds.includes(selectedLevelId)) && availableLevels.length > 0) {
                    selectedLevelId = availableLevels[0].id;
                    selector.value = selectedLevelId;
                }

                // Find the row for the selected level
                let targetRow = null;
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const symbol = cells[1].textContent.trim();
                    const levelPrice = parseFloat(cells[2].textContent);
                    const id = `${symbol}-${levelPrice}`;
                    if (id === selectedLevelId) {
                        targetRow = row;
                    }
                });

                if (!targetRow) return; // Selected level not found (maybe deleted)

                // Parse level data
                const cells = targetRow.querySelectorAll('td');
                const symbol = cells[1].textContent.trim();
                const levelPrice = parseFloat(cells[2].textContent);
                const currentPrice = parseFloat(cells[3].textContent);
                const zone = cells[4].textContent.trim();
                const tier1 = parseFloat(cells[5].textContent);
                const tier2 = parseFloat(cells[6].textContent);
                const tier3 = parseFloat(cells[7].textContent);

                // Update history
                if (!priceHistory[selectedLevelId]) {
                    priceHistory[selectedLevelId] = [];
                }
                priceHistory[selectedLevelId].push(currentPrice);
                if (priceHistory[selectedLevelId].length > MAX_HISTORY) {
                    priceHistory[selectedLevelId].shift();
                }

                // Calculate BOTH zone tiers (LONG and SHORT)
                // LONG zone (Support): Tiers are BELOW level (Level * (1-t))
                const longTier1 = levelPrice * (1 - 0.001);  // -0.1%
                const longTier2 = levelPrice * (1 - 0.002);  // -0.2%
                const longTier3 = levelPrice * (1 - 0.003);  // -0.3%

                // SHORT zone (Resistance): Tiers are ABOVE level (Level * (1+t))
                const shortTier1 = levelPrice * (1 + 0.001);  // +0.1%
                const shortTier2 = levelPrice * (1 + 0.002);  // +0.2%
                const shortTier3 = levelPrice * (1 + 0.003);  // +0.3%

                // Fixed scale showing both zones with padding
                const allPrices = [levelPrice, currentPrice, longTier3, shortTier3]; // Use outermost tiers
                const minVal = Math.min(...allPrices);
                const maxVal = Math.max(...allPrices);
                const range = maxVal - minVal;
                const padding = range * 0.10; // 10% padding on each side

                const minPrice = minVal - padding;
                const maxPrice = maxVal + padding;

                const ctx = document.getElementById('levelChart').getContext('2d');

                if (levelChart) {
                    levelChart.destroy();
                }

                // Create labels for X-axis (just empty strings or timestamps)
                const labels = priceHistory[selectedLevelId].map((_, i) => '');

                levelChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            // Price History Curve
                            {
                                label: `Price: ${currentPrice.toFixed(2)}`,
                                data: priceHistory[selectedLevelId],
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.1, // Smooth curve
                                fill: false,
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false, // Disable animation for smooth updates
                        scales: {
                            y: {
                                min: minPrice,
                                max: maxPrice,
                                title: {
                                    display: true,
                                    text: 'Price (USDT)',
                                    font: { size: 14, weight: 'bold' }
                                },
                                ticks: {
                                    callback: function (value) {
                                        return value.toFixed(2);
                                    }
                                },
                                grid: {
                                    color: '#e0e0e0'
                                }
                            },
                            x: {
                                display: false
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: { size: 12 },
                                    filter: function (item) {
                                        return item.text.includes('Price') || item.text.includes('Base Level');
                                    }
                                }
                            },
                            tooltip: {
                                enabled: true,
                                mode: 'index',
                                intersect: false,
                            },
                            annotation: {
                                annotations: {
                                    // Base Level Line
                                    baseLevelLine: {
                                        type: 'line',
                                        yMin: levelPrice,
                                        yMax: levelPrice,
                                        borderColor: '#000',
                                        borderWidth: 3,
                                        label: {
                                            content: `Base Level: ${levelPrice.toFixed(2)}`,
                                            enabled: true,
                                            position: 'start',
                                            backgroundColor: '#000',
                                            color: '#fff',
                                            font: { size: 11, weight: 'bold' }
                                        }
                                    },
                                    // LONG Zone Background (Below Level)
                                    longZone: {
                                        type: 'box',
                                        yMin: minPrice,
                                        yMax: levelPrice,
                                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                        borderWidth: 0
                                    },
                                    // SHORT Zone Background (Above Level)
                                    shortZone: {
                                        type: 'box',
                                        yMin: levelPrice,
                                        yMax: maxPrice,
                                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                        borderWidth: 0
                                    },
                                    // LONG Tier Lines
                                    longTier1Line: {
                                        type: 'line',
                                        yMin: longTier1,
                                        yMax: longTier1,
                                        borderColor: '#28a745',
                                        borderWidth: 2,
                                        borderDash: [10, 5],
                                        label: {
                                            content: `L-T1: ${longTier1.toFixed(2)}`,
                                            enabled: true,
                                            position: 'start',
                                            backgroundColor: '#28a745',
                                            color: '#fff',
                                            font: { size: 10 }
                                        }
                                    },
                                    longTier2Line: {
                                        type: 'line',
                                        yMin: longTier2,
                                        yMax: longTier2,
                                        borderColor: '#28a745',
                                        borderWidth: 2,
                                        borderDash: [10, 5],
                                        label: {
                                            content: `L-T2: ${longTier2.toFixed(2)}`,
                                            enabled: true,
                                            position: 'start',
                                            backgroundColor: '#28a745',
                                            color: '#fff',
                                            font: { size: 10 }
                                        }
                                    },
                                    longTier3Line: {
                                        type: 'line',
                                        yMin: longTier3,
                                        yMax: longTier3,
                                        borderColor: '#28a745',
                                        borderWidth: 2,
                                        borderDash: [10, 5],
                                        label: {
                                            content: `L-T3: ${longTier3.toFixed(2)}`,
                                            enabled: true,
                                            position: 'start',
                                            backgroundColor: '#28a745',
                                            color: '#fff',
                                            font: { size: 10 }
                                        }
                                    },
                                    // SHORT Tier Lines
                                    shortTier1Line: {
                                        type: 'line',
                                        yMin: shortTier1,
                                        yMax: shortTier1,
                                        borderColor: '#dc3545',
                                        borderWidth: 2,
                                        borderDash: [10, 5],
                                        label: {
                                            content: `S-T1: ${shortTier1.toFixed(2)}`,
                                            enabled: true,
                                            position: 'start',
                                            backgroundColor: '#dc3545',
                                            color: '#fff',
                                            font: { size: 10 }
                                        }
                                    },
                                    shortTier2Line: {
                                        type: 'line',
                                        yMin: shortTier2,
                                        yMax: shortTier2,
                                        borderColor: '#dc3545',
                                        borderWidth: 2,
                                        borderDash: [10, 5],
                                        label: {
                                            content: `S-T2: ${shortTier2.toFixed(2)}`,
                                            enabled: true,
                                            position: 'start',
                                            backgroundColor: '#dc3545',
                                            color: '#fff',
                                            font: { size: 10 }
                                        }
                                    },
                                    shortTier3Line: {
                                        type: 'line',
                                        yMin: shortTier3,
                                        yMax: shortTier3,
                                        borderColor: '#dc3545',
                                        borderWidth: 2,
                                        borderDash: [10, 5],
                                        label: {
                                            content: `S-T3: ${shortTier3.toFixed(2)}`,
                                            enabled: true,
                                            position: 'start',
                                            backgroundColor: '#dc3545',
                                            color: '#fff',
                                            font: { size: 10 }
                                        }
                                    }
                                }
                            }
                        }
                    },
                    plugins: [{
                        id: 'chartAreaBorder',
                        beforeDraw(chart) {
                            const { ctx, chartArea: { left, top, width, height } } = chart;
                            ctx.save();
                            ctx.strokeStyle = '#ccc';
                            ctx.lineWidth = 1;
                            ctx.strokeRect(left, top, width, height);
                            ctx.restore();
                        }
                    }]
                });
            }

            // Update chart when levels table updates
            document.body.addEventListener('htmx:afterSwap', function (event) {
                if (event.detail.target.id === 'levels-table') {
                    updateChart();
                }
            });

            // Initial chart render
            setTimeout(updateChart, 500);
        </script>



        <div class="card">
            <h2>Active Positions</h2>
            <div id="positions-table" hx-get="/positions" hx-trigger="load, every 5s">
                <!-- Loaded via HTMX -->
            </div>
        </div>

        <div class="card">
            <h2>Recent Trades</h2>
            <div hx-get="/trades" hx-trigger="every 5s">
                <!-- Initial load or empty -->
            </div>
        </div>
    </div>
</body>

</html>

{{ define "levels_table" }}
<table>
    <thead>
        <tr>
            <th>Exchange</th>
            <th>Symbol</th>
            <th>Level Price</th>
            <th>Current Price</th>
            <th>Zone/Tiers</th>
            <th>Size</th>
            <th>Lev</th>
            <th>Cooldown</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {{ range . }}
        <tr>
            <td>{{ .Exchange }}</td>
            <td><strong>{{ .Symbol }}</strong></td>
            <td>{{ printf "%.2f" .LevelPrice }}</td>
            <td>{{ printf "%.2f" .CurrentPrice }}</td>
            <td>
                <table style="width: 100%; font-size: 0.9em;">
                    <tr>
                        <td style="font-weight: bold; color: #28a745; padding: 2px;">LONG</td>
                        <td style="background-color: #d4edda; font-weight: bold; padding: 2px;">{{ printf "%.2f" (index
                            .LongTiers 0) }}</td>
                        <td style="background-color: #d4edda; font-weight: bold; padding: 2px;">{{ printf "%.2f" (index
                            .LongTiers 1) }}</td>
                        <td style="background-color: #d4edda; font-weight: bold; padding: 2px;">{{ printf "%.2f" (index
                            .LongTiers 2) }}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold; color: #dc3545; padding: 2px;">SHORT</td>
                        <td style="background-color: #f8d7da; font-weight: bold; padding: 2px;">{{ printf "%.2f" (index
                            .ShortTiers 0) }}</td>
                        <td style="background-color: #f8d7da; font-weight: bold; padding: 2px;">{{ printf "%.2f" (index
                            .ShortTiers 1) }}</td>
                        <td style="background-color: #f8d7da; font-weight: bold; padding: 2px;">{{ printf "%.2f" (index
                            .ShortTiers 2) }}</td>
                    </tr>
                </table>
            </td>
            <td>{{ .BaseSize }}</td>
            <td>{{ .Leverage }}x</td>
            <td>{{ .CoolDownMs }}ms</td>
            <td>
                <button class="delete-btn" hx-delete="/levels/{{ .ID }}" hx-target="#levels-table">Delete</button>
            </td>
        </tr>
        {{ end }}
    </tbody>
</table>
{{ end }}

{{ define "trades_table" }}
<table>
    <thead>
        <tr>
            <th>Time</th>
            <th>Symbol</th>
            <th>Side</th>
            <th>Size</th>
            <th>Price</th>
        </tr>
    </thead>
    <tbody>
        {{ range . }}
        <tr>
            <td>{{ .CreatedAt.Format "15:04:05" }}</td>
            <td>{{ .Symbol }}</td>
            <td>{{ .Side }}</td>
            <td>{{ .Size }}</td>
            <td>{{ .Price }}</td>
        </tr>
        {{ end }}
    </tbody>
</table>
{{ end }}

{{ define "positions_table" }}
<table>
    <thead>
        <tr>
            <th>Symbol</th>
            <th>Side</th>
            <th>Size</th>
            <th>Entry Price</th>
            <th>Mark Price</th>
            <th>Unrealized PnL</th>
            <th>Lev</th>
        </tr>
    </thead>
    <tbody>
        {{ if . }}
        {{ range . }}
        <tr>
            <td>{{ .Symbol }}</td>
            <td>{{ .Side }}</td>
            <td>{{ .Size }}</td>
            <td>{{ .EntryPrice }}</td>
            <td>{{ .CurrentPrice }}</td>
            <td style="color: {{ if gt .UnrealizedPnL 0.0 }}green{{ else }}red{{ end }};">{{ .UnrealizedPnL }}</td>
            <td>{{ .Leverage }}</td>
        </tr>
        {{ end }}
        {{ else }}
        <tr>
            <td colspan="7">No active positions</td>
        </tr>
        {{ end }}
    </tbody>
</table>
{{ end }}